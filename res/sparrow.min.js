(function(ns){ 'use strict';
ns._=function(a,b){void 0===b&&(b=a,a=document);if(!b)return[a];if(0<b.indexOf(" ")||!/^[#.]?\w+$/.test(b))return a.querySelectorAll(b);if("#"===b.charAt(0)){var c=a.getElementById(b.substr(1));return c?[c]:[]}return"."===b.charAt(0)?a.getElementsByClassName(b.substr(1)):a.getElementsByTagName(b)};_.ary=function(a,b,c){return"string"===typeof a||void 0===a.length?[a]:0>=a.length?[]:void 0===b?a instanceof Array?a:Array.prototype.slice.call(a,0):Array.prototype.slice.call(a,b,c)};
_.toAry=function(a){return a instanceof Array?a:[a]};_.col=function(a,b){a=_.ary(a);return void 0===b?a.map(function(a){return a[0]}):2===arguments.length?a.map(function(a){return a[b]}):a.map(function(a){for(var b=[],e=1,f=arguments.length;e<f;e++)b.push(a[arguments[e]]);return b})};_.sorter=function(a,b){var c=b?0:1,d=-c;return function(b,f){return b[a]>f[a]?c:b[a]<f[a]?d:0}};
_.sorter.number=function(a,b){var c=b?0:1,d=-c;return void 0===a?function(a,b){return+a>+b?c:+a<+b?d:0}:function(b,f){return+b[a]>+f[a]?c:+b[a]<+f[a]?d:0}};_.sort=function(a,b,c){return _.ary(a).sort(_.sorter(b,c))};_.mapper=function(a){var b=arguments,c=b.length;return 0>=c?_.dummy():1===c&&"string"===typeof a?function(b){return b[a]}:function(a){for(var e=[],f=_.mapper._map,g=0;g<c;g++)e.push(f(a,b[g]));return 1===c?e[0]:e}};
_.mapper._map=function _mapper_map(b,c){if(_.is.literal(c))return b[c];if(c instanceof Array){for(var d=0,e=c.length;d<e&&void 0!==b&&null!==b;d++)b=b[c[d]];return b}d=new _.Map;for(e in c)d[e]=_mapper_map(b,c[e]);return d};_.map=function(a,b){return _.ary(a).map(_.mapper.apply(null,_.ary(arguments).slice(1)))};_.dummy=function(){};_.echo=function(a){return a};_.call=function(a,b,c){return void 0===a||null===a?void 0:a.apply(b,_.ary(arguments,2))};
_.callonce=function(a){return a?function(){if(a){var b=a;a=null;return b.apply(this,arguments)}}:function(){}};void 0===window.setImmediate&&(window.requestAnimationFrame?(window.setImmediate=window.requestAnimationFrame,window.clearImmediate=window.cancelAnimationFrame):(window.setImmediate=function(a){return window.setTimeout(a,0)},window.clearImmediate=window.clearTimeout));
_.ajax=function(a,b){"string"===typeof a&&(a={url:a});void 0!==b&&(a.onload=b);void 0===a.cor&&(a.cor="file:"===location.protocol);var c=a.url,d=a.xhr;void 0===d&&(a.cor&&_.is.ie()&&(d=new ActiveXObject("Microsoft.XMLHttp")),d||(d=new XMLHttpRequest));_.info("[AJAX] Ajax: "+c);d.open("GET",c);var e=!1;d.onreadystatechange=function(){4===d.readyState&&(_.info("[AJAX] Complete, status "+d.status+": "+c),0<=[0,200,302].indexOf(d.status)&&d.responseText?setImmediate(function(){e||(e=!0,_.call(a.onload,
d,d.responseText,d),_.call(a.ondone,d,d))}):setImmediate(function(){e||(e=!0,_.call(a.onerror,d,d,"HTTP Response Code "+d.status),_.call(a.ondone,d,d))}),d.onreadystatechange=function(){})};try{d.send()}catch(f){_.error("Ajax exception on "+c+": "+f),e=!0,_.call(a.onerror,d,d,f),_.call(a.ondone,d,d)}return d};
_.js=function(a,b){function c(b,c){g||(g=!0,c&&_.info(c),_.call(b,f,d,a),f&&f.parentNode===document.body&&document.body.removeChild(f))}"string"===typeof a&&(a={url:a});void 0!==b&&(a.onload=b);if(a.validate&&a.validate.call(null,d,a))return c(a.onload);var d=a.url;a.harmony&&_.is.firefox()&&(a.type="application/javascript;version=1.8");var e={src:d};a.charset&&(e.charset=a.charset);a.type&&(e.type=a.type);var f=_.create("script",e);_.info("[JS] Load script: "+d);var g=!1;f.addEventListener("load",
function(){setImmediate(function(){if(a.validate&&!_.call(a.validate,f,d,a))return c(a.onerror,"[JS] Script loaded but fails validation: "+d);c(a.onload,"[JS] Script loaded: "+d)})});f.addEventListener("error",function(b){c(a.onerror,"[JS] Script error or not found: "+d)});document.body?document.body.appendChild(f):document.head.appendChild(f);return f};
_.is={ie:function(){var a=/\bMSIE \d|\bTrident\/\d\b./.test(navigator.userAgent);_.is.ie=function(){return a};return a},firefox:function(){var a=/\bGecko\/\d{8}/.test(navigator.userAgent);_.is.firefox=function(){return a};return a},activeX:function(){var a=!1;try{a=!!new ActiveXObject("htmlfile")}catch(b){}_.is.activeX=function(){return a};return a},literal:function(a){if(void 0===a||null===a)return a;a=typeof a;return"boolean"===a||"number"===a||"string"===a},object:function(a){if(void 0===a||null===
a)return a;a=typeof a;return"object"===a||"function"===a},yes:function(a){var b=typeof a;if("string"===b){a=a.trim().toLowerCase();if(0<=["true","on","yes","1"].indexOf(a))return!0;if(0<=["false","off","no","0"].indexOf(a))return!1}else if("boolean"===b||"number"===b)return a?!0:!1;return null}};
_.xml=function(a){if(void 0!==window.DOMParser)return(new DOMParser).parseFromString(a,"text/xml");if(_.is.activeX()){var b=new ActiveXObject("Msxml2.DOMDocument.6.0");b.loadXML(a);return b}throw"XML Parser not supported";};_.xml.toObject=function _xml_toObject(b,c){void 0===c&&(c=new _.Map);c.tagName=b.tagName;_.ary(b.attributes).forEach(function(b){c[b.name]=b.value});_.ary(b.children).forEach(function(b){var e=b.name;b=_xml_toObject(b);void 0===c[e]?c[e]=b:(c[e]=_.ary(c[e]),c[e].push(b))});return c};
_.html=function(a){var b=_.html.node=document.createElement("div");b.innerHTML=a;return b};
_.xsl=function(a,b){var c="string"===typeof a?_.xml(a):a,d="string"===typeof b?_.xml(b):b;if(window.XSLTProcessor){var e=new XSLTProcessor;e.importStylesheet(d);return e.transformToFragment(c,document)}return c.transformNode?c.transformNode(d):_.is.activeX()?(c=new ActiveXObject("Msxml2.DOMDocument.6.0"),c.loadXML(a),d=new ActiveXObject("Msxml2.DOMDocument.6.0"),d.loadXML(b),e=new ActiveXObject("Msxml2.DOMDocument.6.0"),e.async=!1,e.validateOnParse=!0,c.transformNodeToObject(d,e),e):null};
_.xpath=function(a,b){var c=a.ownerDocument;return c.evaluate?c.evaluate(b,a,null,XPathResult.ANY_TYPE,null):c.selectNodes(b)};_.assert=function(a,b){if(!1===a||void 0===a||null===a)throw void 0===b&&(b=""),"string"===typeof b&&(b="Assertion failed ("+b+")"),Error(b);};_.log=function(a,b){void 0===b&&(b=a,a="log");console&&(console[a]||(a="log"),console[a](b))};_.info=function(a){_.log("info",a)};_.warn=function(a){_.log("warn",a)};_.error=function(a){_.log("error",a)};
_.alert=function(a){_.alert.timeout||(_.alert.timeout=setTimeout(function(){_.alert.timeout=0;alert(_.alert.log);_.alert.log=[]},50));0>_.alert.log.indexOf(a)&&_.alert.log.push(a)};_.alert.timeout=0;_.alert.log=[];_.time=function(a){var b=_.time,c=new Date;if(void 0===a)b.base=c,b.last=null;else{var d=c-b.base;_.info(a+" (+"+d+(b.last?"ms,+"+(c-b.last):"")+"ms)");b.last=c;return[c-b.last,d]}};
_.escHtml=function(a){return/[<&'"]/.test(a)?a.replace(/[&<"']/g,function(a){return{"&":"&amp;","<":"&lt;",'"':"&quot;","'":"&#39;"}[a]}):a};_.escJs=function(a){return a.replace(/\r?\n/g,"\\n").replace(/'"/g,"\\$0")};_.escRegx=function(a){return a.replace(/([()?*+.\\{}[\]])/g,"\\$1")};_.round=function(a,b){var c=Math.pow(10,~~b);return Math.round(a*c)/c};
_.si=function(a,b){if("string"===typeof a){if(!/^-?\d+(\.\d+)?[kmgtp]$/i.test(a))return+a;var c=a.length-1,d=a.charAt(c).toLowerCase();return a.substr(0,c)*{k:1E3,m:1E6,g:1E9,t:1E12,p:1E15}[d]}for(c=0;1E3<a||-1E3>a;)a/=1E3,++c;return _.round(a,b)+" k M G T P".split(" ")[c]};_.halfwidth=function(a){for(var b=0,c=0,d=a.length;c<d;c++){var e=a.charCodeAt(c);25>e||(b=511>e?b+1:65376>e?b+2:65439>e?b+1:b+2)}return b};
_.proto=function(a){if(null===a||void 0===a)return a;if("object"===typeof a||"function"===typeof a)return Object.getPrototypeOf(a)};_.inherit=function _inherit(b,c,d){_.assert(!b||b.prototype,_inherit.name+": base must be inheritable");_.assert(null===c||"function"===typeof c,_inherit.name+": constructor must be function");null===c&&(c=b?function(){b.apply(this,arguments)}:function(){});if(b){var e=c.prototype=Object.create(b.prototype);if(d)for(var f in d)e[f]=d[f]}else c.prototype=d;return c};
_.deepclone=function(a){return _.clone(a,!0)};_.clone=function(a,b){var c;if(null===a)return a;switch(typeof a){case "object":c=a instanceof Array?[]:Object.create(Object.getPrototypeOf(a));break;case "function":c=function(){return a.apply(this,arguments)};c.prototype=a.prototype;break;default:return a}for(var d in a)c[d]=b?_.clone(a[d],b):a[d];return c};_.extend=function(a,b){Object.keys(b).forEach(function(c){a[c]=b[c]});return a};_.freeze=Object.freeze?function(a){return Object.freeze(a)}:_.echo;
_.seal=Object.seal?function(a){return Object.seal(a)}:_.echo;_.noExt=Object.preventExtensions?function(a){return Object.preventExtensions(a)}:_.echo;_.noDef=function(a){a&&a.preventDefault&&a.preventDefault();return!1};_.create=function(a,b){var c=document.createElement(a);b&&("object"!==typeof b?c.textContent=b:_.attr(c,b));return c};_.domlist=function(a){return"string"===typeof a?_(a):void 0===a.length?[a]:a};
_.set=function(a,b,c,d){if("string"===typeof a||a&&a[0]instanceof Element){if(d&&"^"!==d)throw Error("Property flags cannot be set on DOM elements");return _.attr(a,b,c)}var e=b,f;_.is.literal(b)&&(e={},e[b]=c);a=_.ary(a);if(d&&"^"!==d&&Object.defineProperties){d=d.toLowerCase();var g={};b=0>d.indexOf("c");c=0>d.indexOf("e");d=0>d.indexOf("w");for(f in e)g[f]={value:e[f],configurable:b,enumerable:c,writable:d};f=function(a){Object.defineProperties(a,g)}}else f=function(a){for(var b in e)a[b]=e[b]};
a.forEach(f);return a};_.proto=function(a){if(void 0===a||null===a)return a;if(_.is.object(a))return Object.getPrototypeOf(a)};
_.attr=function(a,b,c){var d=b;_.is.literal(b)&&(d={},d[b]=c);a=_.ary(_.domlist(a));a.forEach(function(a){for(var b in d)switch(b){case "text":a.textContent=d.text;break;case "html":a.innerHTML=d.html;break;case "class":case "className":a.className=d[b];break;case "style":if("object"===typeof d[b]){_.style(a,d[b]);break}default:"on"===b.substr(0,2)?a.addEventListener(b.substr(2),d[b]):void 0!==d[b]?a.setAttribute(b,d[b]):a.removeAttribute(b)}});return a};
_.style=function(a,b,c){var d=b;"string"===typeof d&&(d={},d[b]=c);"string"===typeof a&&(a=_(a));a=_.ary(a);a.forEach(function(a){for(var b in d)void 0!==d[b]?a.style[b]=d[b]:(a.style[b]="",delete a.style[b])});return a};_.show=function(a){return _.style(a,"display",void 0)};_.hide=function(a){return _.style(a,"display","none")};_.visible=function(a,b){return b?_.show(a):_.hide(a)};_.hasClass=function(a,b){return _.domlist(a).some(function(a){return 0<=a.className.split(/\s+/).indexOf(b)})};
_.addClass=function(a,b){return _.toggleClass(a,b,!0)};_.removeClass=function(a,b){void 0===b&&(b=a.match(/\.[^. :#>+~()\[\]]+$/)[0].substr(1));return _.toggleClass(a,b,!1)};_.toggleClass=function(a,b,c){a=_.domlist(a);for(var d="string"===typeof b?[b]:b,e=a.length-1;0<=e;e--){for(var f=b=a[e].className,f=f.split(/\s+/),g=d.length-1;0<=g;g--){var h=d[g],k=f.indexOf(h);0>k&&(c||void 0===c)?f.push(h):0<=k&&(!c||void 0===c)&&f.splice(k,1)}f=f.join(" ");b!==f&&(a[e].className=f)}return a};_.Map=function(){return Object.create(null)};
_.Latch=function(a,b){"function"===typeof a&&(b=a,a=0);this.count=a;this.ondone=b};_.Latch.prototype={count:0,ondone:null,count_up:function(a){void 0===a&&(a=1);this.count+=a},count_down:function(a){void 0===a&&(a=1);this.count-=a;if(0>this.count)throw Error("IllegalStateException: Latch count below zero");0===this.count&&_.call(this.ondone,this)},count_down_function:function(a){var b=this;return function(){b.count_down(a)}}};
_.Executor=function(a,b){a&&(this.thread=a);b&&(this.interval=b);this.running=[];this.waiting=[]};
_.Executor.prototype={_paused:!1,_lastRun:0,_timer:0,thread:1,interval:0,running:[],waiting:[],add:function(a,b){return this.addTo.apply(this,[this.waiting.length].concat(_.ary(arguments)))},asap:function(a,b){return this.addTo.apply(this,[0].concat(_.ary(arguments)))},addTo:function(a,b,c){b.name||(b.name=b.toString().match(/^function\s+([^\s(]+)/)[1]);_.info("Queue task "+b.name);var d=[b].concat(_.ary(arguments,2));this.waiting.splice(a,0,d);return this.notice()},finish:function(a){_.info("Finish task #"+
a+" "+this.running[a][0].name);this.running[a]=null;return this.notice()},clear:function(){this.waiting=[]},pause:function(){this._paused=!0;this._timer&&clearTimeout(this._timer);return this},resume:function(){this._paused=!1;this.notice();return this},notice:function(){function a(a){c._timer&&clearTimeout(c._timer);c._timer=setTimeout(c.notice.bind(c),a);return c}function b(a,b){_.info("Start task #"+a+" "+b[0].name);try{!1!==b[0].apply(null,[a].concat(b.slice(1)))&&c.finish(a)}catch(d){_.error(d),
c.finish(a)}}this._timer=0;if(this._paused)return this;var c=this,d=0>=this.interval?0:Math.max(0,-(new Date).getTime()+this._lastRun+this.interval);if(12<d)return a(d);for(d=0;d<this.thread&&0<this.waiting.length;d++)if(!this.running[d]){var e=c.waiting.splice(0,1)[0];c.running[d]=e;c._lastRun=(new Date).getTime();setImmediate(b.bind(null,d,e));if(0<c.interval)return a(c.interval)}return this}};
_.EventManager=function(a,b){this.owner=b;var c=this.lst=new _.Map;if(void 0===a)this.strict=!1;else for(var d=0,e=a.length;d<e;d++)c[a[d]]=null};
_.EventManager.prototype={lst:{},owner:null,strict:!0,add:function(a,b){var c=this;if(a instanceof Array)return a.forEach(function(a){c.add(a,b)});if(b instanceof Array)return b.forEach(function(b){c.add(a,b)});var d=this.lst[a];if(!d){if(this.strict&&void 0===d)throw Error("[sparrow.EventManager.add] Cannot add to unknown event '"+a+"'");d=this.lst[a]=[]}this.lst[a].push(b)},remove:function(a,b){var c=this;if(a instanceof Array)return a.forEach(function(a){c.remove(a,b)});if(b instanceof Array)return b.forEach(function(b){c.remove(a,
b)});var d=this.lst[a];if(d){var e=d.indexOf(b);0<=e&&(d.splice(e,1),0>d.length&&(this.lst[a]=null))}else if(this.strict&&void 0===d)throw Error("[sparrow.EventManager.remove] Cannot remove from unknown event '"+a+"'");},fire:function(a,b){var c=this.lst[a];if(c){var d=c.length;b=_.ary(arguments,1);for(var e=0;e<d;e++)c[e].apply(this.owner,b)}else if(this.strict&&void 0===c)throw Error("[sparrow.EventManager.fire] Cannot fire unknown event '"+a+"'");},createFireMethods:function(a){var b=this;_.ary(a).forEach(function(a){Object.hasOwnProperty(b,
a)?_.warn('[sparrow.EventManager.createFireMethods] Fire method "'+a+"' cannot be created."):b[a]=b.fire.bind(b,a)})}};_.l=function(a,b,c){var d=_.l,e=d.getset(a,void 0,d.currentLocale);void 0===e&&(e=void 0!==b?b:a);return 2<arguments.length?3===arguments.length?d.format(""+e,c):d.format.apply(this,[e].concat(_.ary(arguments,2))):e};_.l.format=function(a,b){for(var c=1,d=arguments.length;c<d;c++)a=a.replace("%"+c,arguments[c]);return a};_.l.currentLocale="en";_.l.fallbackLocale="en";_.l.data=new _.Map;
_.l.setLocale=function(a){if(!a)return _.l.detectLocale();a!==_.l.currentLocale&&(_.l.currentLocale=a,_.l.event.fire("locale",a))};_.l.saveLocale=function(a){window.localStorage&&(a?localStorage["_.l.locale"]=a:delete localStorage["_.l.locale"]);_.l.setLocale(a)};
_.l.detectLocale=function(a){var b=_.l,c=Object.keys(b.data);a&&(b.fallbackLocale=a);a=navigator.language||navigator.userLanguage;window.localStorage&&(a=localStorage["_.l.locale"]||a);if(a){if(0<=c.indexOf(a))return b.setLocale(a);a=a.split("-")[0];0<=c.indexOf(a)&&b.setLocale(a)}};
_.l.getset=function(a,b,c){var d=a.split("."),e=_.l,f=d.pop();d.unshift(c);for(var g=e.data,h=0,k=d.length;h<k;h++){var l=d[h];void 0===g[l]&&(g[l]=new _.Map);g=g[l]}if(void 0!==b)g[f]=b;else return void 0===g[f]&&c!==e.fallbackLocale?e.getset(a,void 0,e.fallbackLocale):g[f]};_.l.set=function(a,b){_.l.getset(a,b,_.l.currentLocale);_.l.event.fire("set",a,b)};
_.l.localise=function(a){void 0===a&&(a=document.documentElement);a.setAttribute("lang",_.l.currentLocale);_.ary(_(".i18n")).forEach(function(a){var c=a.getAttribute("data-i18n");if(!c){switch(a.tagName){case "INPUT":c=a.value;break;case "MENUITEM":c=a.getAttribute("label");break;default:c=a.textContent}if(!c)return _.warn("i18 class without l10n key: "+a.tagName.toLowerCase()+(a.id?"#"+a.id:"")+" / "+a.textContext);c=c.trim();a.setAttribute("data-i18n",c)}c=_.l(c,c.split(".").pop());switch(a.tagName){case "INPUT":a.value=
c;break;case "MENUITEM":a.setAttribute("label",c);break;default:a.innerHTML=c}})};_.l.event=new _.EventManager(["set","locale"],_.l);
_.test=function(a,b){if(void 0!==b)document.write("<tr><td>"+_.escHtml(b)+"</td><td>"+(a?"OK":"<b>FAIL</b>")+"</td></tr>");else{document.open();document.write("<!DOCTYPE html><h"+"1 id='sparrow_test'> Testing... </h1>");for(var c in a)c.match(/^test/)&&"function"===typeof a[c]&&(document.write("<table class='sparrow_test_result' border='1'><tr><th colspan='2'>"+_.escHtml(c).replace(/^test_+/,"").replace(/_/g," ")+"</th></tr>"),a[c](),document.write("</table>"));document.close();c=0===_(".sparrow_test_result b").length;
_("#sparrow_test")[0].textContent=c?"Test Success":"Test FAILED"}};_.info("Sparrow loaded.");_.time();})(this);